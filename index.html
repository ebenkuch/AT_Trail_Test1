<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Maryland Appalachian Trail GIS Live Map - Enhanced</title>
    <link rel="stylesheet" href="https://js.arcgis.com/4.29/esri/themes/light/main.css" />
    <script src="https://js.arcgis.com/4.29/"></script>

    <style>
      html, body, #viewDiv {
        height: 100%;
        width: 100%;
        margin: 0;
        padding: 0;
      }

      /* Opacity Control Panel */
      #opacityPanel {
        background: white;
        padding: 15px;
        width: 280px;
        max-height: 500px;
        overflow-y: auto;
        box-shadow: 0 1px 2px rgba(0,0,0,0.3);
      }

      .opacity-control {
        margin-bottom: 15px;
      }

      .opacity-control label {
        display: block;
        font-size: 13px;
        font-weight: 600;
        margin-bottom: 5px;
        color: #323232;
      }

      .opacity-control input[type="range"] {
        width: 100%;
      }

      .opacity-value {
        font-size: 12px;
        color: #6e6e6e;
        float: right;
      }

      /* Drawing Tools Panel */
      #drawPanel {
        background: white;
        padding: 15px;
        width: 250px;
      }

      .draw-button {
        display: block;
        width: 100%;
        padding: 10px;
        margin: 5px 0;
        background: #0079c1;
        color: white;
        border: none;
        border-radius: 3px;
        cursor: pointer;
        font-size: 14px;
      }

      .draw-button:hover {
        background: #005a87;
      }

      .draw-button.active {
        background: #c9252d;
      }

      .draw-button:disabled {
        background: #ccc;
        cursor: not-allowed;
      }

      #hikeInfo {
        margin-top: 10px;
        padding: 10px;
        background: #f0f0f0;
        border-radius: 3px;
        font-size: 12px;
        display: none;
      }

      /* Print Panel */
      #printPanel {
        background: white;
        padding: 15px;
        width: 200px;
      }

      /* Loading indicator */
      .layer-error {
        color: #c9252d;
        font-size: 11px;
        font-style: italic;
      }
    </style>

    <script>
      require([
        "esri/Map",
        "esri/views/MapView",
        "esri/layers/FeatureLayer",
        "esri/layers/GeoJSONLayer",
        "esri/layers/GraphicsLayer",
        "esri/widgets/ScaleBar",
        "esri/widgets/Legend",
        "esri/widgets/LayerList",
        "esri/widgets/Expand",
        "esri/widgets/BasemapGallery",
        "esri/widgets/Sketch",
        "esri/geometry/geometryEngine"
      ], function (
        Map, MapView, FeatureLayer, GeoJSONLayer, GraphicsLayer,
        ScaleBar, Legend, LayerList, Expand, BasemapGallery, Sketch,
        geometryEngine
      ) {

        /***************
         * BASEMAP + VIEW
         ***************/
        const map = new Map({
          basemap: "hybrid"  // Changed to hybrid for better base imagery
        });

        const view = new MapView({
          container: "viewDiv",
          map: map,
          center: [-77.5, 39.55],
          zoom: 10
        });

        // Graphics layer for drawing
        const sketchLayer = new GraphicsLayer({
          title: "My Planned Hikes",
          listMode: "show"
        });
        map.add(sketchLayer);


        /***************
         * LAYERS - GEOJSON (These work!)
         ***************/

        // AT Trail Points
        const atPoints = new GeoJSONLayer({
          url: "https://raw.githubusercontent.com/ebenkuch/AT_Trail_Test1/main/AppTrail_pts.geojson",
          title: "AT Trail Points",
          opacity: 1.0,
          outFields: ["*"],
          renderer: {
            type: "simple",
            symbol: {
              type: "simple-marker",
              size: 8,
              color: [255, 170, 0, 0.9],
              outline: {
                width: 1.5,
                color: [255, 255, 255, 1]
              }
            }
          },
          popupTemplate: {
            title: "AT Trail Point",
            content: "{*}"
          }
        });

        // Public Areas
        const publicAreas = new GeoJSONLayer({
          url: "https://raw.githubusercontent.com/ebenkuch/AT_Trail_Test1/main/AppTrail_MD_Frederick%20County_Public%20Areas.geojson",
          title: "Public Areas",
          opacity: 0.6,
          outFields: ["*"],
          renderer: {
            type: "simple",
            symbol: {
              type: "simple-fill",
              color: [34, 139, 34, 0.3],
              outline: {
                color: [34, 139, 34, 0.8],
                width: 2
              }
            }
          },
          popupTemplate: {
            title: "Public Area",
            content: "{*}"
          }
        });

        // Parcel Zoning
        const parcelZoning = new GeoJSONLayer({
          url: "https://raw.githubusercontent.com/ebenkuch/AT_Trail_Test1/main/MD_AT_ParcelZoning_2milebuff_20251121.geojson",
          title: "Parcel Zoning (2mi)",
          opacity: 0.4,
          outFields: ["*"],
          popupTemplate: {
            title: "Zoning Info",
            content: "{*}"
          }
        });

        // Catchments
        const fredCatch = new GeoJSONLayer({
          url: "https://raw.githubusercontent.com/ebenkuch/MD-GIS-Testing/f3bc4f02dd16a798ba1831739261cc5defdb178b/test2.geojson",
          title: "Catchments (1 mile)",
          opacity: 0.5,
          outFields: ["*"],
          renderer: {
            type: "simple",
            symbol: {
              type: "simple-fill",
              color: [0, 100, 255, 0.2],
              outline: {
                color: [0, 100, 255, 0.6],
                width: 1.5
              }
            }
          },
          popupTemplate: {
            title: "Catchment Area",
            content: "{*}"
          }
        });

        // State Parks - FIXED URL (removed double https://)
        const stateParks = new GeoJSONLayer({
          url: "https://raw.githubusercontent.com/ebenkuch/AT_Trail_Test1/refs/heads/main/State%20Parks_MD.geojson",
          title: "State Parks",
          opacity: 0.5,
          outFields: ["*"],
          renderer: {
            type: "simple",
            symbol: {
              type: "simple-fill",
              color: [76, 153, 0, 0.3],
              outline: {
                color: [76, 153, 0, 0.8],
                width: 2
              }
            }
          },
          popupTemplate: {
            title: "State Park",
            content: "{*}"
          }
        });


        /***************
         * WORKING FEATURE LAYERS
         ***************/

        // MDOT Roads - This one works!
        const mdotLayer = new FeatureLayer({
          url: "https://services.arcgis.com/njFNhDsUCentVYJW/arcgis/rest/services/MDOT_Know_Your_Roads/FeatureServer/0",
          title: "MDOT Roads",
          opacity: 0.7,
          outFields: ["*"],
          popupTemplate: {
            title: "{ROAD_NAME}",
            content: `
              Route Number: {ROUTE_NUM}<br>
              Functional Class: {FUNC_CLASS}
            `
          }
        });


        /***************
         * NOTE: The following MD state layers have CORS restrictions
         * and cannot be loaded directly in web browsers.
         * Alternative: Use their WMS services or download as GeoJSON
         ***************/
        
        // If you need parcels, LIDAR, or NAIP, you'll need to:
        // 1. Download them as GeoJSON from iMap
        // 2. Host them on your GitHub
        // 3. Add as GeoJSONLayers like the others above


        // Add all working layers to map
        map.addMany([
          parcelZoning,
          fredCatch,
          stateParks,
          publicAreas,
          mdotLayer,
          atPoints
        ]);


        /***************
         * OPACITY CONTROLS
         ***************/
        const opacityLayers = [
          { layer: mdotLayer, name: "MDOT Roads" },
          { layer: fredCatch, name: "Catchments" },
          { layer: stateParks, name: "State Parks" },
          { layer: atPoints, name: "AT Points" },
          { layer: publicAreas, name: "Public Areas" },
          { layer: parcelZoning, name: "Parcel Zoning" }
        ];

        const opacityDiv = document.createElement("div");
        opacityDiv.id = "opacityPanel";
        opacityDiv.innerHTML = "<h3 style='margin-top:0'>Layer Opacity</h3>";

        opacityLayers.forEach(item => {
          const control = document.createElement("div");
          control.className = "opacity-control";
          
          const currentOpacity = Math.round(item.layer.opacity * 100);
          
          control.innerHTML = `
            <label>
              ${item.name}
              <span class="opacity-value" id="${item.name.replace(/\s+/g, '_')}_value">${currentOpacity}%</span>
            </label>
            <input type="range" 
                   min="0" 
                   max="100" 
                   value="${currentOpacity}"
                   id="${item.name.replace(/\s+/g, '_')}_slider">
          `;
          
          opacityDiv.appendChild(control);

          // Add event listener after adding to DOM
          setTimeout(() => {
            const slider = document.getElementById(`${item.name.replace(/\s+/g, '_')}_slider`);
            const valueSpan = document.getElementById(`${item.name.replace(/\s+/g, '_')}_value`);
            
            if (slider && valueSpan) {
              slider.addEventListener('input', (e) => {
                const value = parseInt(e.target.value);
                item.layer.opacity = value / 100;
                valueSpan.textContent = value + '%';
              });
            }
          }, 100);
        });

        const opacityExpand = new Expand({
          view: view,
          content: opacityDiv,
          expanded: false,
          expandIconClass: "esri-icon-settings2",
          expandTooltip: "Adjust Layer Opacity"
        });
        view.ui.add(opacityExpand, "top-right");


        /***************
         * DRAWING TOOLS - Plan a Hike
         ***************/
        const drawDiv = document.createElement("div");
        drawDiv.id = "drawPanel";
        drawDiv.innerHTML = `
          <h3 style='margin-top:0'>Plan a Hike</h3>
          <button class="draw-button" id="drawLineBtn">Draw Trail Route</button>
          <button class="draw-button" id="drawAreaBtn">Draw Planning Area</button>
          <button class="draw-button" id="clearBtn">Clear All</button>
          <div id="hikeInfo"></div>
        `;

        const drawExpand = new Expand({
          view: view,
          content: drawDiv,
          expanded: false,
          expandIconClass: "esri-icon-edit",
          expandTooltip: "Plan a Hike"
        });
        view.ui.add(drawExpand, "top-right");

        // Sketch widget for drawing
        const sketch = new Sketch({
          layer: sketchLayer,
          view: view,
          creationMode: "update",
          availableCreateTools: ["polyline", "polygon"]
        });

        // Drawing button handlers
        let activeButton = null;

        document.addEventListener('click', (e) => {
          if (e.target.id === 'drawLineBtn') {
            if (activeButton) activeButton.classList.remove('active');
            e.target.classList.add('active');
            activeButton = e.target;
            sketch.create("polyline");
          } else if (e.target.id === 'drawAreaBtn') {
            if (activeButton) activeButton.classList.remove('active');
            e.target.classList.add('active');
            activeButton = e.target;
            sketch.create("polygon");
          } else if (e.target.id === 'clearBtn') {
            sketchLayer.removeAll();
            document.getElementById('hikeInfo').style.display = 'none';
            if (activeButton) {
              activeButton.classList.remove('active');
              activeButton = null;
            }
          }
        });

        // Calculate hike statistics
        sketch.on("create", (event) => {
          if (event.state === "complete") {
            const graphic = event.graphic;
            const geometry = graphic.geometry;
            
            let infoHTML = "";
            
            if (geometry.type === "polyline") {
              const lengthMiles = geometryEngine.geodesicLength(geometry, "miles");
              infoHTML = `
                <strong>Trail Route:</strong><br>
                Distance: ${lengthMiles.toFixed(2)} miles<br>
                <small>Tip: Click graphic to edit</small>
              `;
            } else if (geometry.type === "polygon") {
              const areaAcres = geometryEngine.geodesicArea(geometry, "acres");
              const perimeterMiles = geometryEngine.geodesicLength(geometry, "miles");
              infoHTML = `
                <strong>Planning Area:</strong><br>
                Area: ${areaAcres.toFixed(2)} acres<br>
                Perimeter: ${perimeterMiles.toFixed(2)} miles<br>
                <small>Tip: Click graphic to edit</small>
              `;
            }
            
            const hikeInfoDiv = document.getElementById('hikeInfo');
            hikeInfoDiv.innerHTML = infoHTML;
            hikeInfoDiv.style.display = 'block';
            
            if (activeButton) {
              activeButton.classList.remove('active');
              activeButton = null;
            }
          }
        });


        /***************
         * PRINT/EXPORT
         ***************/
        const printDiv = document.createElement("div");
        printDiv.id = "printPanel";
        printDiv.innerHTML = `
          <h3 style='margin-top:0'>Export Map</h3>
          <button class="draw-button" id="screenshotBtn">Save as Image</button>
          <button class="draw-button" id="printBtn">Print Map</button>
          <p style="font-size: 11px; color: #6e6e6e; margin-top: 10px;">
            Screenshot captures current view with all visible layers
          </p>
        `;

        const printExpand = new Expand({
          view: view,
          content: printDiv,
          expanded: false,
          expandIconClass: "esri-icon-printer",
          expandTooltip: "Export/Print Map"
        });
        view.ui.add(printExpand, "top-right");

        // Screenshot functionality
        document.addEventListener('click', (e) => {
          if (e.target.id === 'screenshotBtn') {
            view.takeScreenshot({ format: "png", quality: 1 }).then((screenshot) => {
              const link = document.createElement("a");
              link.href = screenshot.dataUrl;
              link.download = `AT_Trail_Map_${new Date().toISOString().split('T')[0]}.png`;
              link.click();
            }).catch(err => {
              console.error("Screenshot failed:", err);
              alert("Screenshot failed. Please try again.");
            });
          } else if (e.target.id === 'printBtn') {
            window.print();
          }
        });


        /***************
         * STANDARD WIDGETS
         ***************/
        const scaleBar = new ScaleBar({
          view,
          unit: "dual"
        });
        view.ui.add(scaleBar, "bottom-right");

        const legendExpand = new Expand({
          view,
          content: new Legend({ view }),
          expanded: false,
          expandTooltip: "Legend"
        });
        view.ui.add(legendExpand, "top-right");

        const layerListExpand = new Expand({
          view,
          content: new LayerList({ view }),
          expanded: false,
          expandTooltip: "Layer List"
        });
        view.ui.add(layerListExpand, "top-right");

        const basemapExpand = new Expand({
          view,
          content: new BasemapGallery({ view }),
          expanded: false,
          expandTooltip: "Basemaps"
        });
        view.ui.add(basemapExpand, "top-right");


        /***************
         * ERROR HANDLING & LOGGING
         ***************/
        
        // Log layer load status
        const layersToWatch = [atPoints, publicAreas, parcelZoning, fredCatch, stateParks, mdotLayer];
        
        layersToWatch.forEach(layer => {
          layer.when(() => {
            console.log(`✓ ${layer.title} loaded successfully`);
          }).catch(err => {
            console.error(`✗ ${layer.title} failed to load:`, err);
          });
        });

      });
    </script>
  </head>

  <body>
    <div id="viewDiv"></div>
  </body>
</html>
